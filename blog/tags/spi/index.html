<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu (Incubating)" href="/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed"><title data-react-helmet="true">3 posts tagged with &quot;spi&quot; | Apache ShenYu (Incubating)</title><meta data-react-helmet="true" property="og:title" content="3 posts tagged with &quot;spi&quot; | Apache ShenYu (Incubating)"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//blog/tags/spi"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//blog/tags/spi"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/spi" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/tags/spi" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/tags/spi" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.32e5b75e.css">
<link rel="preload" href="/assets/js/runtime~main.54856423.js" as="script">
<link rel="preload" href="/assets/js/main.6901035d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" role="banner"><div class="announcementBarContent_6uhP announcementBarCloseable_y4cp">‚≠êÔ∏è &nbsp; If you like Apache ShenYu (Incubating), give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/apache/incubator-shenyu">GitHub</a></div><button type="button" class="announcementBarClose_A3A1 clean-btn" aria-label="Close"><span aria-hidden="true">√ó</span></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/docs/index">Document</a><a class="navbar__item navbar__link" href="/community/subscribe-email">Community</a><a class="navbar__item navbar__link" href="/event/2.4.1-release">Event</a><a class="navbar__item navbar__link" href="/news">News</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/index">2.4.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/index">Next</a></li><li><a class="dropdown__link" href="/docs/index">2.4.1</a></li><li><a class="dropdown__link" href="/docs/2.4.0/index">2.4.0</a></li><li><a class="dropdown__link" href="/docs/2.3.0/index">2.3.0</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog/tags/spi" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/tags/spi" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">ÁÆÄ‰Ωì‰∏≠Êñá</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_SrOn thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_jISh margin-bottom--md">All Blog Posts</div><ul class="sidebarItemList_UfcF"><h4 class="categoryHeader_Xx2W">DataSync</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocket Data Synchronization Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeper Data Synchronization Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Http Long Polling Data Synchronization Source Code Analysis</a></li><h4 class="categoryHeader_Xx2W">Plugin</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Code Analysis For Context-Path Plugin</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin">Code Analysis For Param-Mapping Plugin</a></li><h4 class="categoryHeader_Xx2W">SPI</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalance SPI Source Code Analysis</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy  -- analyze the design based on SPI</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge -- analyze the design based on SPI</a></li><h4 class="categoryHeader_Xx2W">Start</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu Start Demo</a></li></ul></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;spi&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalance SPI Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-11-15T08:24:21.807Z">November 15, 2021</time> ¬∑ 13 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/changanjennifer/" target="_blank" rel="noopener noreferrer">Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>Gateway applications need to support a variety of load balancing  strategies, including <code>random</code>,<code>Hashing</code>, <code>RoundRobin</code> and so on. In <code>Apache Shenyu</code> gateway, it not only realizes such traditional algorithms, but also makes smoother traffic processing for the entry of server nodes through detailed processing such as traffic <code>warm-up,</code> so as to obtain better overall stability. In this article, let&#x27;s walk through how <code>Apache Shenyu</code> is designed and implemented this part of the function.</p><blockquote><p>This article based on <code>shenyu-2.4.0</code> version of the source code analysis.</p></blockquote><p>[TOC]</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalance-spi"></a>LoadBalance <code>SPI</code><a class="hash-link" href="#loadbalance-spi" title="Direct link to heading">#</a></h2><p>The implementation of <code>LoadBalance</code> is in <strong><em>shenyu-plugin-divide</em></strong> module. It has based on its <code>SPI</code> creation mechanism. The core interface code is shown as follows. This interface  well explains the concept: load balancing is to select the most appropriate node from a series of server nodes.  Routing, traffic processing and load balancing is the basic function of <code>LoadBalance</code> <code>SPI</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface LoadBalance {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DivideUpstream select(List&lt;DivideUpstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Where <code>upstreamList</code> represents the server nodes list available for routing. <code>DivideUpstream</code> is the data structure of server node, the  important elements including <code>protocol</code>, <code>upstreamUrl</code> , <code>weight</code>, <code>timestamp</code>, <code>warmup</code>.  </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DivideUpstream implements Serializable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String upstreamHost;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * this is http protocol.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String protocol;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String upstreamUrl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * false close/ true open.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Builder.Default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean status = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long timestamp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int warmup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-loadbalance-module"></a>Design of LoadBalance module<a class="hash-link" href="#design-of-loadbalance-module" title="Direct link to heading">#</a></h2><p>The class diagram of <code>LoadBalance</code> module<code>is</code>shown as follows.</p><p><img alt="loadbalance-class-diagram" src="/assets/images/loadbalance-class-diagram-9bfc1b2f9cb359702481d7f739ae21f7.png"></p><p>We can draw the outline of <code>LoadBalance</code> module from the class diagram:</p><ol><li><p>The abstract class <code>AbstractLoadBalance</code> implements the SPI <code>LoadBalance</code> interfaceÔºåand supplies the template methods for selection related, such as select(), selector()Ôºåand gives the calculation of weight.</p></li><li><p>Three implementation classes which inherit <code>AbstractLoadBalance</code> to realize their own logic:</p><ul><li><code>RandomLoadBalance</code> - Weight Random</li><li><code>HashLoadBalance</code>  - Consistent Hashing</li><li><code>RoundRobinLoadBalance</code> -Weight Round Robin per-packet</li></ul></li><li><p>The utility class <code>LoadBalanceUtil</code> provides public static method to be called.</p><p>The implementation classes and algorithms are configurable.   According to its specification,   by adding profile in <code>SHENYU_DIERECTORY</code> directory, the data in profile should be  <em>key</em>=<em>value-class</em> format, where the <em>value-class</em> will be load by the <code>Apache Shenyu SPI</code> class loader, and <em>key</em> value should be an <code>name</code> defined in <code>LoadBalanceEnum.</code></p></li></ol><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">random=org.apache.shenyu.plugin.divide.balance.spi.RandomLoadBalance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">roundRobin=org.apache.shenyu.plugin.divide.balance.spi.RoundRobinLoadBalance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hash=org.apache.shenyu.plugin.divide.balance.spi.HashLoadBalance</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>The code of LoadBalanceEnum</code> is as followsÔºö</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum LoadBalanceEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Hash load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    HASH(1, &quot;hash&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Random load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RANDOM(2, &quot;random&quot;, true),</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Round robin load balance enum.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ROUND_ROBIN(3, &quot;roundRobin&quot;, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int code;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final String name;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final boolean support;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractloadbalance"></a>AbstractLoadBalance<a class="hash-link" href="#abstractloadbalance" title="Direct link to heading">#</a></h2><p>This abstract class implements the <code>LoadBalance</code> interface and define the abstract method <code>doSelect()</code> to be processed by the implementation classes. In the template method <code>select()</code>,  It will do validation first then call the <code>doSelect()</code> method.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   /** </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Do select divide upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract DivideUpstream doSelect(List&lt;DivideUpstream&gt; upstreamList, String ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DivideUpstream select(final List&lt;DivideUpstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(upstreamList)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (upstreamList.size() == 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doSelect(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the <code>timestamp</code> of server node  is not null, and the interval between current time and <code>timestamp</code> is within the traffic warm-up time, the formula for weight calculation is.
$$ {1-1}
ww = min(1,uptime/(warmup/weight))
$$
It can be seen from the formula that the final weight(<code>ww</code>) is proportional to the original-<code>weight</code> value. The closer the time interval is to the <code>warmup</code> time, the greater the final <code>ww</code>. That is, the longer the waiting time of the request, the higher the final <code>weight</code>. When there is no <code>timestamp</code> or other conditions, the <code>ww</code> is equal to the <code>weight</code> value of <code>DivideUpstream</code> object.</p><p>The central of thinking about <em>warm-up</em>is to avoid  bad performance when adding new server and the new <code>JVMs</code> starting up.</p><p>Let&#x27;s see how the load balancing  with <code>Random</code>, <code>Hashing</code> and <code>RoundRobin</code> strategy is implemented.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="randomloadbalance"></a>RandomLoadBalance<a class="hash-link" href="#randomloadbalance" title="Direct link to heading">#</a></h2><p>The <code>RandomLoadBalance</code> can handle two situations:</p><ol><li>Each node without weight, or every node has the same weight, randomly choose one.</li><li>Server Nodes with different weight, choose one randomly by weight.</li></ol><p>Following is the <code>random()</code> method of <code>RandomLoadBalance</code>. When traversing server node list, if the randomly generated value is less than the weight of node, then the current node will be chosen. If after one round traversing, there&#x27;s is no server node match, then it will return the first item of the list. The <code>getWeight(DivideUpstream upstream)</code> is defined in <code>AbstractLoadBalance</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private DivideUpstream random(final int totalWeight, final List&lt;DivideUpstream&gt; upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If the weights are not the same and the weights are greater than 0, then random by the total number of weights</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int offset = RANDOM.nextInt(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Determine which segment the random value falls on</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DivideUpstream divideUpstream : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            offset -= getWeight(divideUpstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (offset &lt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return divideUpstream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="hashloadbalance"></a>HashLoadBalance<a class="hash-link" href="#hashloadbalance" title="Direct link to heading">#</a></h2><p>In <code>HashLoadBalance</code>, it takes the advantages of <a href="https://en.wikipedia.org/wiki/Consistent_hashing" target="_blank" rel="noopener noreferrer">consistent hashing</a> , that maps both the input traffic and the servers to a unit circle, or name as  <em>hash ring</em>. For the requested<code>ip</code> address, with its hash value to find the node closest in clockwise order as the node to be routed.  Let&#x27;s see how consistent hashing is implemented in <code>HashLoadBalance</code>.</p><p>As to the hash algorithms, <code>HashLoadBalance</code> uses <code>MD5</code> hash, which has the advantage of mixing the input in an unpredictable but deterministic way. The output is a 32-bit integer.  the code is shown as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private static long hash(final String key) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // md5 byte</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    MessageDigest md5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        md5 = MessageDigest.getInstance(&quot;MD5&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (NoSuchAlgorithmException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShenyuException(&quot;MD5 not supported&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] keyBytes;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyBytes = key.getBytes(StandardCharsets.UTF_8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    md5.update(keyBytes);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] digest = md5.digest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // hash code, Truncate to 32-bits</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long hashCode = (long) (digest[3] &amp; 0xFF) &lt;&lt; 24</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[2] &amp; 0xFF) &lt;&lt; 16)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | ((long) (digest[1] &amp; 0xFF) &lt;&lt; 8)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            | (digest[0] &amp; 0xFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return hashCode &amp; 0xffffffffL;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Importantly, how to generate the hash ring and avoid skewness?  Let&#x27;s the<code>doSelect()</code> method in<code>HashLoadBalance</code> as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private static final int VIRTUAL_NODE_NUM = 5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DivideUpstream doSelect(final List&lt;DivideUpstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ConcurrentSkipListMap&lt;Long, DivideUpstream&gt; treeMap = new ConcurrentSkipListMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DivideUpstream address : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; VIRTUAL_NODE_NUM; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                long addressHash = hash(&quot;SOUL-&quot; + address.getUpstreamUrl() + &quot;-HASH-&quot; + i);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                treeMap.put(addressHash, address);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hash = hash(String.valueOf(ip));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SortedMap&lt;Long, DivideUpstream&gt; lastRing = treeMap.tailMap(hash);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!lastRing.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return lastRing.get(lastRing.firstKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return treeMap.firstEntry().getValue();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this method, duplicated labels are used which are called &quot;virtual nodes&quot; (i.e.  5 virtual nodes point to a single &quot;real&quot; server).  It will make the distribution in hash ring more evenly, and reduce the occurrence of data skewness.</p><p>In order to rescue the data sorted in the hash ring, and can be accessed quickly, we use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html" target="_blank" rel="noopener noreferrer">ConcurrentSkipListMap</a> of Java to store the server node lists ( with virtual nodes) and its hash value as key.  This class a member of <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/collections/index.html" target="_blank" rel="noopener noreferrer">Java Collections Framework</a>, providing expected average <em>log(n)</em> time cost for retrieve and access operations safely execute concurrent by multiple threads.  </p><p>Furthermore, the method tailMap(K fromKey) of  <code>ConcurrentSkipListMap</code> can return a view of portion of the map whose keys are greater or equal to the <code>fromKey</code>, and not need to navigate the whole map.</p><p>In the above code section, after the hash ring is generated, it uses <code>tailMap(K fromKey)</code> of <code>ConcurrentSkipListMap</code> to find the subset that the elements greater, or equal to the hash value of the requested <code>ip</code>, its first element is just the node to be routed. With the suitable data structure, the code looks particularly clear and concise.</p><p>Consistent hashing resolved the poor scalability of the traditional hashing by modular operation.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="roundrobinloadbalance"></a>RoundRobinLoadBalance<a class="hash-link" href="#roundrobinloadbalance" title="Direct link to heading">#</a></h2><p>The original Round-robin selection is to select server nodes one by one from the candidate list. Whenever some nodes has crash ( ex, cannot be connected after 1 minute), it will be removed from the candidate list, and do not attend the next round, until the server node is recovered and it will be add to the candidate list again.  In <code>RoundRobinLoadBalance</code>,the weight Round Robin per-packet schema is implemented.</p><p>In order to work in concurrent system, it provides an inner static class <code>WeigthRoundRobin</code> to store and calculate the rolling selections of each server node. Following is the main section of this class( removed remark )</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">protected static class WeightedRoundRobin {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicLong current = new AtomicLong(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setWeight(final int weight) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.weight = weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.set(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long increaseCurrent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return current.addAndGet(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void sel(final int total) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        current.addAndGet(-1 * total);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setLastUpdate(final long lastUpdate) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.lastUpdate = lastUpdate;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Please focus on the these method:</p><ul><li><p><code>setWeight(final int weight)</code> : set the current value by <em>weight</em></p></li><li><p><code>increaseCurrent()</code>: Increment the <code>current</code> value by <code>weight</code>, and <code>current</code> set to 0. </p></li><li><p><code>sel(final int total)</code>: decrement  the <code>current</code> value by  <em>total</em></p><p>Let&#x27;s see how the weight factor being used in this round-robin  selection? </p><p>First it defines a two-level  <code>ConcurrentMap</code> type variable named as <code>methodWeightMap</code> , to cache the server node lists and the rolling selection data about each server node.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private final ConcurrentMap&lt;String, ConcurrentMap&lt;String, WeightedRoundRobin&gt;&gt; methodWeightMap = new ConcurrentHashMap&lt;&gt;(16);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In this map, the key of first level is  set to <code>upstreamUrl</code> of first element in server node list. The type of second object is <code>ConcurrentMap&lt;String, WeightedRoundRobin&gt;,</code> the key of this inner Map is  the value <code>upstreamUrl</code>variable of each server node in this server list, the value object is <code>WeightedRoundRobin</code>, used to trace the rolling selection data about each server node. As to the implementation class for the  Map object, we use <code>ConcurrentHashMap</code> of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html" target="_blank" rel="noopener noreferrer">JUC</a>,  a hash table supporting full concurrency of retrievals and high expected concurrency for updates.</p><p>In the second level of the map, the embedded  static class - <code>WeighedRoundRobin</code> of each node is thread-safe, implementing the weighted <code>RoundRobin</code> per bucket. The following is the code of the <code>doselect()</code> method of this class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public DivideUpstream doSelect(final List&lt;DivideUpstream&gt; upstreamList, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String key = upstreamList.get(0).getUpstreamUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConcurrentMap&lt;String, WeightedRoundRobin&gt; map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (map == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        methodWeightMap.putIfAbsent(key, new ConcurrentHashMap&lt;&gt;(16));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        map = methodWeightMap.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int totalWeight = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long maxCurrent = Long.MIN_VALUE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    long now = System.currentTimeMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DivideUpstream selectedInvoker = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    WeightedRoundRobin selectedWRR = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (DivideUpstream upstream : upstreamList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String rKey = upstream.getUpstreamUrl();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        WeightedRoundRobin weightedRoundRobin = map.get(rKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int weight = getWeight(upstream);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (weightedRoundRobin == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin = new WeightedRoundRobin();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            map.putIfAbsent(rKey, weightedRoundRobin);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (weight != weightedRoundRobin.getWeight()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //weight changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            weightedRoundRobin.setWeight(weight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long cur = weightedRoundRobin.increaseCurrent();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        weightedRoundRobin.setLastUpdate(now);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cur &gt; maxCurrent) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            maxCurrent = cur;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedInvoker = upstream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectedWRR = weightedRoundRobin;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        totalWeight += weight;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ......  //erase the section which handles the time-out upstreams. </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (selectedInvoker != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWRR.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For example we assume <code>upstreamUrl</code> values of three server nodes is: LIST = [upstream-20, upstream-50, upstream-30]. After a round of execution, the data in newly created <code>methodWeightMap</code> is as follows:</p><p><img alt="methodWeightMap" src="/assets/images/methodWeightMap-90b4a77aedffd8cd88bc12b9551739ad.png"></p><p>For the above example LIST, assumes the  <code>weight</code> array is  [20,50,30].  the following figure shows the value change and polling selection process of the <code>current</code> array in <code>WeighedRoundRobin</code> object.</p><p><img alt="weighted-roundrobin-demo" src="/assets/images/weighted-roundrobin-demo-cec02fd422fb01ef73e882e0966a8cec.png"></p><p>In each round, it will choose the server node with max <code>current</code> value.</p><ul><li>Round1:<ul><li>Traverse the server node list, initialize the <code>weightedRoundRobin</code> instance of each server node or update  the <code>weight</code> value of server nodes object <code>DivideUpstream</code></li><li>say, in this case,  after traverse, the <code>current</code> array  of the node list changes to  [20, 50,30]Ôºåso according to rule, the node Stream-50 would be chosen, and then the static object <code>WeightedRoundRobin</code> of  Stream-50 executes <code>sel(-total)</code> , the <code>current</code> array is now [20,-50, 30].</li></ul></li><li>Round 2:  after traverse, the <code>current</code> array should be [40,0,60],  so the Stream-30 node would be chosenÔºå <code>current</code> array is now  [40,0,-40].</li><li>Round 3:  after traverse, <code>current</code> array  changes to [60,50,-10],  Stream-20 would be chosenÔºåand <code>current</code> array is now [-40,50,-10].</li></ul><p>When there is any inconsistence or some server crashed, for example, the lists size does not match with the elements in map, it would copy and modify the element with lock mechanism, and remove the timeout server node,  the data in Map updated. Following is the fault tolerance code segment.  </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Java"><pre tabindex="0" class="prism-code language-Java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    if (!updateLock.get() &amp;&amp; upstreamList.size() != map.size() &amp;&amp; updateLock.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // copy -&gt; modify -&gt; update reference</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConcurrentMap&lt;String, WeightedRoundRobin&gt; newMap = new ConcurrentHashMap&lt;&gt;(map);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            newMap.entrySet().removeIf(item -&gt; now - item.getValue().getLastUpdate() &gt; recyclePeriod);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            methodWeightMap.put(key, newMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateLock.set(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (selectedInvoker != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectedWRR.sel(totalWeight);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectedInvoker;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // should not happen here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return upstreamList.get(0);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="loadbalanceutils"></a>LoadBalanceUtils<a class="hash-link" href="#loadbalanceutils" title="Direct link to heading">#</a></h2><p>In this class, a static method calling <code>LoadBalance</code> is provided, where<code>ExtensionLoader</code> is the entry point of <code>Apache Shenyu SPI</code>. That is to say, <code>LoadBalance</code> module is configurable and extensible. The <code>algorithm</code> variable in this static method is the <code>name</code> enumeration type defined in <code>LoadBalanceEnum</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Selector divide upstream.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param upstreamList the upstream list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param algorithm    the loadBalance algorithm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param ip           the ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the divide upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static DivideUpstream selector(final List&lt;DivideUpstream&gt; upstreamList, final String algorithm, final String ip) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LoadBalance loadBalance = ExtensionLoader.getExtensionLoader(LoadBalance.class).getJoin(algorithm);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return loadBalance.select(upstreamList, ip);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="using-of-loadbalance-module"></a>Using of LoadBalance module<a class="hash-link" href="#using-of-loadbalance-module" title="Direct link to heading">#</a></h2><p>In the above section, we describe the <code>LoadBalance</code> <code>SPI</code> and three implementation classes. Let&#x27;s take a look at how the <code>LoadBalance</code> to be used in <code>Apache Shenyu</code>. <a href="http://shenyu.apache.org/docs/plugin-center/http-handle/divide-plugin" target="_blank" rel="noopener noreferrer">DividePlugin</a> is a <code>plugin</code> in <code>Apache Shenyu</code> responsible for routing <code>http</code> request. when enable to use this <code>plugin</code>, it will transfer traffic according to selection data and rule data, and deliver to next plugin downstream.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SneakyThrows</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final ShenyuPluginChain chain, final SelectorData selector, final RuleData rule) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The type of second parameter of <code>doExecute()</code> is <code>ShenyuPluginChain</code>, which represents the execution chain of <code>plugins</code>. For details, see the mechanism of <a href="http://shenyu.apache.org/docs/design/flow-control" target="_blank" rel="noopener noreferrer">Apache Shenyu Plugins</a>. The third one is <code>SelectorData</code> type, and the fourth is <code>RuleData</code> type working as  the rule data.</p><p>In <code>doExecute()</code> of <code>DividePlugin</code>,  first verify the size of <code>header</code>, content length,  etc, then preparing for load balancing.</p><p>Following is a code fragment using<code>LoadBalance</code> in the <code>doExecute()</code> method:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   // find the routing server node list</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   List&lt;DivideUpstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ... </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // the requested ip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String ip =   Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //calling the Utility class and invoke the LoadBalance processing.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    DivideUpstream divideUpstream = LoadBalanceUtils.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p> In the above code, the output of<code>ruleHandle.getLoadBalance()</code> is the <code>name</code> variable defined in <code>LoadBalanceEnum</code>, that is <code>random</code>, <code>hash</code>, <code>roundRobin</code>, etc.  It is very convenient to use <code>LoadBalance</code> by <code>LoadBalanceUtils</code>. When adding more  <code>LoadBalance</code> implementing classes,  the interface in <code>plugin</code> module will not be affect at all.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>After reading through the code of <code>LoadBalance</code> module, from the design perspective, it is concluded that this module has the  following characteristics:</p><ol><li>Extensibility: Interface oriented design and implemented on <code>Apache Shenyu SPI</code> mechanism, it can be easily extended to other dynamic load balancing algorithms (for example, least connection, fastest mode, etc), and supports cluster processing.</li><li>ScalabilityÔºö Every load balancing implementation,  weighted Random, consistency  Hashing and weighted <code>RoundRobin</code> can well support increase or decrease cluster overall capacity.</li><li>More detailed design such as <em>warm-up</em> can bring better performance and obtain better overall stability.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/load-balance">load balance</a><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about LoadBalance SPI Source Code Analysis" href="/blog/SPI-SourceCode-Analysis-LoadBalance-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy  -- analyze the design based on SPI</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-11-15T08:24:21.807Z">November 15, 2021</time> ¬∑ 5 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p>In most of the <code>plugins</code> ( such as <code>Dubbo</code>, <code>gRPC</code>,<code>Spring-cloud</code>, etc) of <code>Apache Shenyu</code>, the <code>routing</code>parameters are designed to support the combination of multiple conditions. In order to realize such requirements,  the parameters and behaviors are abstracted to three parts according to its <code>SPI</code> mechanism,  and implemented in <strong><em>shenyu-plugin-base</em></strong>  module.</p><ul><li><code>ParameterData</code>-parameters</li><li><code>PredictJudge</code>-predicate</li><li><code>MatchStrategy</code>-matching strategy</li></ul><p>Relatively speaking, the <code>MatchStrategy</code> is the part that needs the least extension points. For the combination judgement of multiple conditions, the common select rules are: All conditions are matched, at least one is match, at least the first is met, or most of conditions  satisfied.  As well  need to handle various type of parameters, for example: <code>IP</code>, <code>header</code>, <code>uri</code>, etc.  How to make the <code>MatchStrategy</code> to be simple to use and extensible?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy"></a>MatchStrategy<a class="hash-link" href="#matchstrategy" title="Direct link to heading">#</a></h2><p>The implementation of <code>MatchStrategy</code> is in <strong><em>shenyu-plugin-base</em></strong> module. It has based on the SPI creation mechanism, and used factory pattern and strategy design pattern. The class diagram of <code>MatchStrategy</code> <code>is</code> showed as follows.</p><p><img alt="MatchStrategy-class-diagram" src="/assets/images/MatchStrategy-class-diagram-ac006eef5089ce92a972e039b431100b.PNG"></p><p>Base on the interface <code>MatchStrategy</code> to design the implementation classes, and the  abstract class <code>AbstractMatchStrategy</code> supplies common method, while the factory class <code>MatchStrategyFactory</code> provides creation  functions.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategy-interface"></a>MatchStrategy Interface<a class="hash-link" href="#matchstrategy-interface" title="Direct link to heading">#</a></h2><p>First, let&#x27;s look at the <code>MatchStrategy</code> <code>SPI</code> interface</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean match(List&lt;ConditionData&gt; conditionDataList, ServerWebExchange exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The annotation <code>@SPI</code> means that this is an <code>SPI</code> interface. Where <code>ServerWebExchange</code> is <code>org.springframework.web.server.ServerWebExchange</code>, represents the request-response  interactive content of of HTTP. Following is the code of <code>ConditionData</code>, the more detail about this class can refer to <a href="http://shenyu.apache.org/blog/PredicateJudge-SPI" target="_blank" rel="noopener noreferrer">code analysis</a> of <code>PredicteJudge</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionData {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramType;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String operator;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramName;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String paramValue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="abstractmatchstrategy"></a>AbstractMatchStrategy<a class="hash-link" href="#abstractmatchstrategy" title="Direct link to heading">#</a></h2><p>Second, let&#x27;s look at the abstract class <code>AbstractMatchStrategy</code>Ôºåit has defined a <code>buildRealData</code>  methodÔºåin this method wrapped various parameters to a unified interface  through the functionality of <code>ParameterDataFactory</code>,  which is the factory class of <code>ParameterData</code>. There supports a variety  types of  parameters , such as <code>Ip</code>, <code>Cookie</code>, <code>Header</code>,<code>uri</code>, etc.  Modifications of such parameters will not impact the calling of matching rules of <code>MatchStrategy</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractMatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String buildRealData(final ConditionData condition, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ParameterDataFactory.builderData(condition.getParamType(), condition.getParamName(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="implementation-class-and-profile"></a>Implementation class and profile<a class="hash-link" href="#implementation-class-and-profile" title="Direct link to heading">#</a></h2><p>Then, let&#x27;s look at the two implementation class based on the above interface in  <strong><em>shenyu-plugin-base</em></strong> module , that is:</p><ul><li><p><code>AndMatchStrategy</code>- <code>AND</code> -All conditions are matched</p></li><li><p><code>OrMatchStrategy</code>-   <code>OR</code> -at least one is match</p><p>The profile  is shown as follows, which locates at the <code>SHENYU_DIRECTORY</code>directory. When starting up, the top-level SPI classes will read the key-value and  load the classes and cache them.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">and=org.apache.shenyu.plugin.base.condition.strategy.AndMatchStrategy</span></span><span class="token-line" style="color:#393A34"><span class="token plain">or=org.apache.shenyu.plugin.base.condition.strategy.OrMatchStrategy</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>These two implementation classes inherit <code>AbstractMatchStrategy</code> and implement <code>MatchStrategy</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="andmatchstrategy---and-relation"></a>AndMatchStrategy-  ‚ÄúAND‚Äù relation<a class="hash-link" href="#andmatchstrategy---and-relation" title="Direct link to heading">#</a></h3><p>Because <code>PredicateJudge</code> encapsulates the diversity of Predicate , and <code>ConditionData</code> and <code>ParameData</code> can present variety of parameters, for treating of multiple conditions, using<code>stream</code> and <code>lambda</code> expression, It can be very simple and efficient to process &quot;AND&quot; logic- all conditions must be matched.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AndMatchStrategy extends AbstractMatchStrategy implements MatchStrategy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean match(final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return conditionDataList</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .allMatch(condition -&gt; PredicateJudgeFactory.judge(condition, buildRealData(condition, exchange)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>OrMatchStrategy</code> similarly implements the &quot;OR&quot; logic- at least one is match.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="matchstrategyfactory"></a>MatchStrategyFactory<a class="hash-link" href="#matchstrategyfactory" title="Direct link to heading">#</a></h2><p>This is the factory class of <code>MatchStrategy</code>Ôºåthere are  two methods,  one is <code>newInstance()</code>, which will return the <code>MatchStrategy</code> implementation class instance cached by the <code>SPI</code> <code>ExtensionLoader</code> indexed by the key-value.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static MatchStrategy newInstance(final Integer strategy) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String matchMode = MatchModeEnum.getMatchModeByCode(strategy);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(MatchStrategy.class).getJoin(matchMode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>the <code>matchMode</code> will be the name of strategy, the value will be &quot;and&quot; or &quot;or&quot;. The <code>MatchModeEnum</code> defines the code and name of match strategy as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">AND(0, &quot;and&quot;), </span></span><span class="token-line" style="color:#393A34"><span class="token plain">OR(1, &quot;or&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Another method is <code>match()</code> method, which will invoke the <code>match()</code> method of  implementation class. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static boolean match(final Integer strategy, final List&lt;ConditionData&gt; conditionDataList, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(strategy).match(conditionDataList, exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-it-works"></a>How it works<a class="hash-link" href="#how-it-works" title="Direct link to heading">#</a></h2><p><code>AbstractShenyuPlugin</code> is the base class of <code>plugins</code> in <code>shenyu-plugin</code> module. In this class two selection method are defined: <code>filterSelector()</code> and <code>filterRule()</code> , Both of them call the  <code>match()</code> method of <code>MatchStrategyFactory</code>. The code  of <code>filterSelector()</code> is shown as follows.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterSelector(final SelectorData selector, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (selector.getType() == SelectorTypeEnum.CUSTOM_FLOW.getCode()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (CollectionUtils.isEmpty(selector.getConditionList())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return MatchStrategyFactory.match(selector.getMatchMode(), selector.getConditionList(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In <code>filterSelector</code>() method, after validation of  the <code>SelectorData</code>, calls the <code>match</code> method of <code>MatchStrategyFactory</code>, and then this factory class will invokes the <code>match</code> method of corresponding implementation class. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Boolean filterRule(final RuleData ruleData, final ServerWebExchange exchange) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ruleData.getEnabled() &amp;&amp; MatchStrategyFactory.match(ruleData.getMatchMode(), ruleData.getConditionDataList(), exchange);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In <code>filterRule()</code> it is also calls the  <code>match()</code> method of <code>MatchStrategyFactory</code>.  Does it look particularly concise or even simple?  In the <a href="http://shenyu.apache.org/blog/PredicateJudge-SPI" target="_blank" rel="noopener noreferrer">code analysis</a> of  <code>PredicteJudge</code> , you can  see more detail about parameter processing in <code>shenyu-plugin</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="summary"></a>Summary<a class="hash-link" href="#summary" title="Direct link to heading">#</a></h2><p>Due to the use of  <code>SPI</code> mechanism of <code>Apache Shen</code>, the parameter selection module has the characteristic of loose coupling and extensibility. In terms of  the combination of multiple conditions, <code>MatchStrategy</code> provides a good design.  Although currently only two implementation classes are present, it can be easily develop more complex <code>MatchStrategy</code> rules in the future,  such as &quot;<code>firstOf</code>&quot;-first condition must matched, or &quot;<code>mostOf</code>&quot;- most of the conditions must be matched, etc.</p><p>Interested readers can read the source code of <code>&#x27;shenyu-plugin&#x27;</code> to learn more.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about MatchStrategy  -- analyze the design based on SPI" href="/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge -- analyze the design based on SPI</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-11-15T08:24:21.807Z">November 15, 2021</time> ¬∑ 6 min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a>Huihui Yin</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><p><strong>Apache Shenyu</strong> has been identified as a gateway application which supports a variety of protocols and  microservice frameworks such as  Dubbo, gRPC, Spring-Cloud, etc.  To do this, the product has accomplished an elegant <code>SPI</code> (Service Provider Interface) as its foundation, and make the  Rule data parsing and predicting program very simple , resiliency and security. As to rule data parsing processing,  the <code>SPI</code> design increases the product&#x27;s scalability. When appending new plugin, in most cases, the   existing module is enough for rule data parsing , otherwise it can be rapidly carry out with tiny effort. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="top-level-design-of-spi"></a>Top level design of SPI<a class="hash-link" href="#top-level-design-of-spi" title="Direct link to heading">#</a></h2><p> In <code>Apache Shenyu</code>, the <code>SPI</code> archtecure is defined in <strong><em>shenyu-spi</em></strong> module and composed of three parts:   <code>SPI</code> interface,  factory  design pattern,  and configuration file. There is  two interface defined as annotation: @SPI and @Join. When class file with  @Join annotation,  it means that it will join as an <code>SPI</code> extension class, in other words, it is an application or registration.  The  @SPI denotes that the class is an <code>SPI</code> extension class.</p><p>Fig 1 classes in the <strong><em>shenyu-spi</em></strong></p><p><img alt="toplevel-SPI" src="data:image/png;base64,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"></p><p>The SPI configuration directory is  <code>META-INF/shenyu/.</code>  that is specified:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">SHENYU_DIRECTORY = &quot;META-INF/shenyu/&quot;;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When starting the gateway system , the <code>ExtensionLoader</code> will scan the profiles under  <code>SHENYU_DIRECTORY</code>,  in turn, load and validate and then  initialize each configed class. The configuration file uses  &quot;Key = class-file&quot; format.  During operation of the system,  the corresponding <code>SPI</code> implementation class will be invoked through the factory mechanism.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="implementation-of-shenyu-plugin-spi"></a>Implementation of shenyu-plugin SPI<a class="hash-link" href="#implementation-of-shenyu-plugin-spi" title="Direct link to heading">#</a></h2><p>In <strong><em>shenyu-plugin</em></strong> module,  various plugins for HTTP routing are implemented according to the plugin mechanism, including  request, redirect, response and rewrite, etc.  Plugins for microservice frameworks such as Dubbo, gRPC , Spring-Cloud and Tars have been developed in the gateway product.  And plugins are still increasing. If  no such  dependent module fo parsing and judge routing  parameters and data,  each plugin is necessary to implement the parsing functions, and has to frequently  modify  to support their matching rules, such as wildcard, regular expression, SpEL expression, etc. Therefore,  they made a high level abstraction for routing parameter data following the <code>SPI</code> framework in  <strong><em>shenyu-plugin</em></strong> module.  The rule analysis consists of three parts:</p><ul><li><p><code>ParameterData</code>- parameter data</p></li><li><p><code>PredicatJudge</code>-  predicate whether the actural data match the rule</p></li><li><p><code>MatchStrategy</code>- combine multiple conditions, the final used strategy</p></li></ul><p>These implementation classes are defined in <strong><em>shenyu-plugin-base</em></strong> module. In each plugin, resolution and predication of  the routing parameter can be realized through <code>AbstractShenyuPlugin</code> using the above  <code>SPIs</code>. That is dedicated and easy to extend, in line with SOLID principle.</p><p>‚Äã      This section analyzes the  <code>PredictJudge</code> in detail. You can find the dependency to <strong><em>shenyu-spi</em></strong> in the pom.xml of this module.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.shenyu</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">shenyu-spi</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="design-of-predicatejudge-spi"></a>Design of PredicateJudge SPI<a class="hash-link" href="#design-of-predicatejudge-spi" title="Direct link to heading">#</a></h3><p><code>PredicateJudge</code> <code>SPI</code>  is used to analyze and judge various routing rules configed in <code>Apache Shenyu</code> gateway.  The name and functions of this SPI are similar to <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener noreferrer">Predicate</a>  in Java, but the acceptance behavior is further  abstracted applying for routing aspect. This <code>SPI</code> is implemented through the Factory pattern.  Let&#x27;s look at the <code>Predictejudge</code> <code>SPI</code> interface:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@FunctionalInterface</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PredicateJudge {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * judge conditionData and realData is match.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param conditionData {@linkplain ConditionData}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param realData       realData</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return true is pass  false is not pass.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean judge(ConditionData conditionData, String realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The class diagram is as follows:</p><p>Fig 2-<code>Predicate</code> class diagram</p><p><img alt="predicate-class-diagram" src="/assets/images/predicate-class-diagram-67a93b8c3e49800b23fe717c22027c54.png"></p><p>The important  methods of <code>PredicateJudgeFactory</code>  are shown as follows:</p><p>Whenever need to parsing and matching routing data, you can use</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static PredicateJudge newInstance(final String operator) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExtensionLoader.getExtensionLoader(PredicateJudge.class).getJoin(processSpecialOperator(operator));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static Boolean judge(final ConditionData conditionData, final String realData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(conditionData) || StringUtils.isBlank(realData)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return newInstance(conditionData.getOperator()).judge(conditionData, realData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ConditionData</code> contains of four attributes of String type: <code>paramType</code>, <code>operator</code>,<code>paramName</code>,<code>paramValue</code> </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="paramtypeenum"></a>ParamTypeEnum<a class="hash-link" href="#paramtypeenum" title="Direct link to heading">#</a></h4><p>Where <strong>paramType</strong> must be the  enumeration type  <code>ParamTypeEnum</code>. The default supported <code>paramType</code> are:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">post, uri,query, host, ip,header, cookie,req_method</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="operatorenum"></a>OperatorEnum<a class="hash-link" href="#operatorenum" title="Direct link to heading">#</a></h4><p><strong>operator</strong> must be the enumeration type <code>OperatorEnum</code>, currently  supported operators are:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   match, =,regex, &gt;,&lt;, contains, SpEL,  Groovy, TimeBefore,TimeAfter</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Base on the above defination , the plugin module provides  the following  eight <code>PredicateJudge</code>  implemetation classes to realize the logic of these operators respectively. </p><table><thead><tr><th>Implementation class</th><th>Logic description</th><th>corespondece operator</th></tr></thead><tbody><tr><td><code>ContainsPredicateJudge</code></td><td>&quot;contain&quot; relation, the actual data needs contain the specified string</td><td>contains</td></tr><tr><td><code>EqualsPredicateJudge</code></td><td>equals &quot;=&quot;</td><td>=</td></tr><tr><td><code>MatchPredicateJudge</code></td><td>used for URI context path matching</td><td>match</td></tr><tr><td><code>TimerAfterPredicateJudge</code></td><td>Whether the local time is after the specified time</td><td>TimeBefore</td></tr><tr><td><code>TimerBeforePredicateJudge</code></td><td>Whether the local time is before the specified time</td><td>TimeAfter</td></tr><tr><td><code>GroovyPredicateJudge</code></td><td>used Groovy syntax toe set ParamName and value data</td><td>Groovy</td></tr><tr><td><code>RegexPredicateJudge</code></td><td>used Regex to match</td><td>regex</td></tr></tbody></table><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="how-to-use-predicatejudge"></a>How to use PredicateJudge<a class="hash-link" href="#how-to-use-predicatejudge" title="Direct link to heading">#</a></h3><p>When you want to parse parameters, you only need to call <code>PredicateJudgeFactory</code> as follows. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">PredicateJudgeFactory.judge(final ConditionData conditionData, final String realData);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="spi-profile"></a>SPI profile<a class="hash-link" href="#spi-profile" title="Direct link to heading">#</a></h3><p>The implementation class is configed in the file under directory <code>SHENYU_DIRECTORY</code> . It  will be loaded and cached at startup. </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">equals=org.apache.shenyu.plugin.base.condition.judge.EqualsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">contains=org.apache.shenyu.plugin.base.condition.judge.ContainsPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Groovy=org.apache.shenyu.plugin.base.condition.judge.GroovyPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">match=org.apache.shenyu.plugin.base.condition.judge.MatchPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">regex=org.apache.shenyu.plugin.base.condition.judge.RegexPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SpEL=org.apache.shenyu.plugin.base.condition.judge.SpELPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeAfter=org.apache.shenyu.plugin.base.condition.judge.TimerAfterPredicateJudge</span></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeBefore=org.apache.shenyu.plugin.base.condition.judge.TimerBeforePredicateJudge</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-usage-of-predicatejudge-spi-in-shenyu-gateway"></a>The usage of PredicateJudge SPI in Shenyu gateway<a class="hash-link" href="#the-usage-of-predicatejudge-spi-in-shenyu-gateway" title="Direct link to heading">#</a></h2><p>Most plugins in <code>Apache Shenyu</code> are inherited from <code>AbstractShenyuPlugin</code>.  In this abstract class, the filter functions (selection and matching) are achieved through  <code>MatchStrategy</code> <code>SPI</code>, and <code>PredicateJudge</code> will be invoked from <code>MatchStrategy</code>  to predicate each condition data. </p><p>Fig 3- class diagram of plugins with <code>PredicateJudge</code> and <code>MatchStrategy</code> <code>SPI</code></p><p><img alt="plugin-SPI-class-diagram" src="/assets/images/plugin-SPI-class-diagram-fa432591b833ff178cb662ce352f5b23.png"></p><p>The process from client request  calling the routing parsing moodule is showed as following chart.</p><p>Fig 4- flow chart for Shenyu gateway filter  with parameter processing</p><p><img alt="SPI-flow-diagram" src="/assets/images/SPI-flow-diagram-590f2cd298ae7655330a62a2010b006e.png"></p><ul><li>When startup, the system will load <code>SPI</code> classes from profile and cache them.</li><li>When the client sends a new request to the Shenyu gateway,  will call the corresponding plugin within  the gateway.</li><li>When analyzing real data with routing rules, the  <code>PredicateJudge</code> implementation class  will be invoked according to the contained operator.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="others"></a>Others<a class="hash-link" href="#others" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="examples-of-predicatejudge--judgement"></a>Examples of PredicateJudge  judgement<a class="hash-link" href="#examples-of-predicatejudge--judgement" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="containspredicatejudge---contains-rule"></a>ContainsPredicateJudge- &quot; contains‚Äú rule<a class="hash-link" href="#containspredicatejudge---contains-rule" title="Direct link to heading">#</a></h4><p>For example, giving a <code>ConditionData</code>  with: <code>paramType</code>=&quot;uri&quot;, <code>paramValue</code> ÊòØ &quot;/http/**&quot;,  when using the &quot;contains&quot; relation: <code>ContainsPredicateJudge</code>, the matching result is as follows.</p><table><thead><tr><th><code>ConditionData</code>  (operator=&quot;contains&quot;)</th><th>real data</th><th>judge result</th></tr></thead><tbody><tr><td>paramType=&quot;uri&quot;,    &quot;/http/**&quot;</td><td>&quot;/http/**/test&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/test/http/**/other&quot;</td><td>true</td></tr><tr><td></td><td>&quot;/http1/**&quot;</td><td>false</td></tr></tbody></table><p>About other <code>PredicateJudge</code> implemetantion classes, you  can  refer to the code and test classes.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/spi">SPI</a><a class="margin-horiz--sm" href="/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col text--right"><a aria-label="Read more about PredicateJudge -- analyze the design based on SPI" href="/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ShenYu</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/index">Document</a></li><li class="footer__item"><a class="footer__link-item" href="/news">News</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Releases<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/community/subscribe-email">Community</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Subscribe mailing list</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/community/subscribe-email">How to subscribe</a></li><li class="footer__item"><a href="mailto://dev-subscribe@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Subscribe Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Mail Archive<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div><img style="height:50px" alt="Apache Software Foundation" src="/img/incubator-logo.png"><p style="color:#ffffffcf;font-size:14px;text-align:left">Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
      <p style="color:white;font-size:14px;"> Copyright ¬© 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
      <div></div></div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.54856423.js"></script>
<script src="/assets/js/main.6901035d.js"></script>
</body>
</html>